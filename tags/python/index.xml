<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>python on Shawn Vause - Shawn Vause's Blog</title><link>https://shawn.vause.us/tags/python/</link><description>Recent content in python on Shawn Vause - Shawn Vause's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Fri, 03 Dec 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://shawn.vause.us/tags/python/index.xml" rel="self" type="application/rss+xml"/><item><title>Getting Python to AWS Lambda From Non-Linux Environments</title><link>https://shawn.vause.us/posts/python-local-to-lambda/</link><pubDate>Fri, 03 Dec 2021 00:00:00 +0000</pubDate><guid>https://shawn.vause.us/posts/python-local-to-lambda/</guid><description>&lt;p>AWS Lambda supports a variety of ways to get code and dependencies up and running in the cloud. You can use &lt;a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" title="AWS Lambda Layers" target="_blank">Lambda layers&lt;/a>, &lt;a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html" title="AWS Lambda Custom Runtimes" target="_blank">custom runtimes&lt;/a> or for ultimate control just specify a full &lt;a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-images.html" title="AWS Lambda Container Support" target="_blank">container&lt;/a> definition and push that up to ECR/Docker Hub for use by the Lambda platform. However, as flexible as Lambda is, there are two approaches that stand above the rest as &amp;ldquo;drop-dead simple&amp;rdquo;. You can write your code in the browser with the built in editor, but let&amp;rsquo;s be honest that isn&amp;rsquo;t the best development experience, or you can zip your assets up locally and push them to the cloud. This is of course provided that your assets/dependencies are less than the &lt;a href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" title="AWS Lambda Zip Size" target="_blank">50MB&lt;/a> cap at the time of writing this post. The remaining content of this post will focus on the zip deployment approach and problems you can run into when working on a Mac/Windows environment which most professional developers are likely to spend the bulk of their time in.
### end preview ###
&lt;/p>
&lt;p>Python being the target function language for our routine has some design considerations to orient ourselves with when we do a ​pip install​ of package dependencies locally. Typically, a pip package will be compiled on the platform it is installed on by the python wheel. As a result, you can run into problems where MacOS does things differently than Windows or Linux during that compilation. For example, MacOS handles encryption differently than Windows and differently than Linux being a FreeBSD based operating system. The compiled dependency will likely be incompatible with the Linux OS running in the Lambda platform. Any zip file we push up to the cloud must have the dependencies compiled for the host Linux context!&lt;/p>
&lt;p>So how do we solve the previously described problem? Enter the &lt;a href="https://github.com/lambci/docker-lambda" title="lambci/docker-lambda Repository" target="_blank">lambci&lt;/a> collection of docker images which includes the ​&lt;a href="https://github.com/lambci/docker-lambda/blob/master/python3.8/build/Dockerfile" title="lambci Python 3.8 Build Dockerfile" target="_blank">lambci/lambda:build-python3.8&lt;/a> for python version 3.8. This image includes all the necessary build tooling for installing python dependencies with pip. The goal of the lambci project is to produce a docker image that is as close to the AWS host environment for a Lambda function as possible. This is a great way to test your function code locally while iterating quickly during development. Using the build image previously mentioned, we are able to build our zip file within docker for uploading to AWS and share it out locally via a docker volume. Here is a handy script you can use in bash for creating your python code archive:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Execute from your python3.8 code directory&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Copy contents to temp directory&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp -r ./ ./temp &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> ./temp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Run the lambci container with a volume in the personal working directory. Then execute the commands&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in the container to do a local pip install. Finally, zip contents from the /var/task path in the container.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -v &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$PWD&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>:/var/task lambci/lambda:build-python3.8 &lt;span class="nb">cd&lt;/span> /var/task &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>pip install --target ./packages -r requirements.txt &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>zip -r mycode.zip ./ -x &lt;span class="s2">&amp;#34;packages/*&amp;#34;&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> packages/ &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span>zip -ur ../mycode.zip ./
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>The comments explain what is going on, but it is important to mention that when we create the zip file we initially exclude the packages directory created by the targeted pip install​. We then add the installed packages to the root of the zip avoiding folder nesting that will prevent the dependencies from being recognized by the Lambda runtime. Take a look at this &lt;a href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-awscli.html" title="Using Lambda with the AWS CLI" target="_blank">documentation&lt;/a> to upload your zip into AWS Lambda via the AWS CLI! If all goes according to plan you will be running your function with properly detected dependencies!&lt;/p></description></item></channel></rss>