<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Pulumi is an Infrastructure as Code (IaC) solution with fantastic superpowers tools like Terraform and Cloudformation do not provide. Using our favorite programming languages over domain specific languages (DSLs) offers benefits for the cloud developer familiar with traditional programming languages and tools. Cross stack infrastructure resources in Pulumi programs offers even more flexibility. Using a simple example for the DigitalOcean platform, we will illustrate the benefits the Pulumi paradigm can offer.'><meta name=author content='Shawn Vause'><meta name=copyright content='Shawn Vause'><title>Think Outside the Stack With Pulumi</title>
<link rel=canonical href=https://shawn.vause.us/posts/think-outside-stack-pulumi/><link rel=stylesheet href=/scss/style.min.c315874e60f24d98eb2c38b7d661b3b60b2a3123ae9791aeaa0d8960639cdc63.css><meta property='og:title' content="Think Outside the Stack With Pulumi"><meta property='og:description' content="Pulumi is an Infrastructure as Code (IaC) solution with fantastic superpowers tools like Terraform and Cloudformation do not provide. Using our favorite programming languages over domain specific languages (DSLs) offers benefits for the cloud developer familiar with traditional programming languages and tools. Cross stack infrastructure resources in Pulumi programs offers even more flexibility. Using a simple example for the DigitalOcean platform, we will illustrate the benefits the Pulumi paradigm can offer."><meta property='og:url' content='https://shawn.vause.us/posts/think-outside-stack-pulumi/'><meta property='og:site_name' content="Shawn Vause - Shawn Vause's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='infrastructure-as-code'><meta property='article:tag' content='digital-ocean'><meta property='article:tag' content='cloud'><meta property='article:published_time' content='2021-09-27T00:00:00+00:00'><meta property='article:modified_time' content='2021-09-27T00:00:00+00:00'><meta name=twitter:site content="@SuperVause"><meta name=twitter:creator content="@SuperVause"><meta name=twitter:title content="Think Outside the Stack With Pulumi"><meta name=twitter:description content="Pulumi is an Infrastructure as Code (IaC) solution with fantastic superpowers tools like Terraform and Cloudformation do not provide. Using our favorite programming languages over domain specific languages (DSLs) offers benefits for the cloud developer familiar with traditional programming languages and tools. Cross stack infrastructure resources in Pulumi programs offers even more flexibility. Using a simple example for the DigitalOcean platform, we will illustrate the benefits the Pulumi paradigm can offer."><script async src="https://www.googletagmanager.com/gtag/js?id=G-KNPRK3WBWJ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KNPRK3WBWJ",{anonymize_ip:!1})}</script><script>document.onreadystatechange=function(){if(document.readyState=="complete"){var e=document.getElementById("recommendations-error");e&&e.remove()}}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/profile_hu2f761c4ecc1fe6bfe80b19bc1cf67e14_232950_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Shawn Vause's Blog</a></h1><h2 class=site-description>AWS Certified Full Stack Software Engineer</h2></div></header><ol class=menu-social><li><a href=https://www.credly.com/users/shawn-vause target=_blank title=Credly rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-certificate" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="15" cy="15" r="3"/><path d="M13 17.5V22l2-1.5 2 1.5v-4.5"/><path d="M10 19H5a2 2 0 01-2-2V7c0-1.1.9-2 2-2h14a2 2 0 012 2v10a2 2 0 01-1 1.73"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="12" x2="9" y2="12"/><line x1="6" y1="15" x2="8" y2="15"/></svg></a></li><li><a href=https://www.facebook.com/vause target=_blank title=Facebook rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-facebook" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li><li><a href=https://github.com/napalm684 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.instagram.com/napalm684 target=_blank title=Instagram rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-instagram" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="4"/><circle cx="12" cy="12" r="3"/><line x1="16.5" y1="7.5" x2="16.5" y2="7.501"/></svg></a></li><li><a href=https://www.linkedin.com/in/shawn-vause/ target=_blank title=Linkedin rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://twitter.com/SuperVause target=_blank title=X rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4l11.733 16H20L8.267 4z"/><path d="M4 20l6.768-6.768m2.46-2.46L20 4"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/think-outside-stack-pulumi/>Think Outside the Stack With Pulumi</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 27, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p><a href=https://www.pulumi.com/ title=Pulumi target=_blank>Pulumi</a> is a powerful infrastructure as code (IaC) tool with a fantastic superpower you just don&rsquo;t get with products like <a href=https://www.terraform.io/ title=Terraform target=_blank>HashiCorp&rsquo;s Terraform</a>. You can harness the power of your favorite programming <a href=https://www.pulumi.com/docs/intro/languages/ title="Pulumi Languages" target=_blank>languages</a> and apply them for another purpose. Rather than learning a domain specific language (DSL) that is largely a &ldquo;one-trick pony&rdquo; you can make your favorite programming language build cloud infrastructure! How cool is that? HashiCorp Configuration Language (<a href=https://www.terraform.io/docs/language/syntax/configuration.html title="HCL Syntax" target=_blank>HCL</a>), while powerful, is frankly used for one thing and one thing only, infrastructure. It can do the job well, there is no argument we have gotten our mileage out of this tool and tools like it (I am looking at you AWS Cloudformation). However, it immediately starts to break down as you get more sophisticated. Looping, conditionals, etc. while supported have largely been bolted on as customers started to hit the edges of this tool chain. Which begged the important and maybe obvious question, &ldquo;Why are we forcing ourselves to use a language not designed for this level of sophistication, when we have world class languages that would certainly be up to the task?&rdquo; As a result, I would argue another wave of IaC tools was kicked off with players like AWS launching their Cloud Development Kit (CDK), Pulumi launching a cross-cloud/cross-service SDK and even HashiCorp recognized the need to grow past HCL. I will leave the reader to investigate the merits of each toolchain, as this was not the intent of this post. Today I want to introduce the Pulumi stack concept and the flexibility it can provide in building our cloud infrastructure.</p><p>Let&rsquo;s start by setting the stage. Pulumi is organized per their <a href=https://www.pulumi.com/docs/intro/concepts/ title="Pulumi Architecture" target=_blank>documentation</a> as follows:<br><br><img src=pulumi-arch.png alt="Pulumi Architecture" style="display:block;margin:0 auto"></p><p>Based on this diagram we see that a project is essentially a collection of program(s) that create resources producing inputs and outputs. What is not immediately clear and is an issue I have with this diagram are the stacks. While a project certainly contains programs, resources and stacks, it isn&rsquo;t apparent that stacks are essentially an isolated &ldquo;snapshot&rdquo; of a program&rsquo;s execution and the resources it produced. They map very well to system environment contexts (as shown with dev, qa and prod callouts). In other words, stacks, put simply, define the state of our infrastructure for that &ldquo;snapshot&rdquo; under an identifier like the environment name.</p><p>With the aforementioned said, another point of friction is with the documentation around <a href=https://www.pulumi.com/docs/intro/concepts/project/ title="Pulumi Projects" target=_blank>projects</a>. The documentation seems to overload the &ldquo;project&rdquo; label as it is represented on this diagram. It seems to refer to &ldquo;projects&rdquo; not only as a collection of programs, but also as a program itself. They clarify this further by explaining that any directory containing the ​Pulumi.yml file is considered a &ldquo;project&rdquo;. This unfortunately introduces some confusion for the reader. When you look at the UI in the Pulumi state management solution you would expect the root element of the Pulumi hierarchy to be the name codified in the yaml file. However it is not, there is a higher root level concept that maps to your repository (for example in GitHub). For sake of discussion, we will refer to this GitHub project as a &ldquo;group&rdquo; since it appears to organize Pulumi projects (programs) with their stacks. This results in my opinion of what the mental model should actually look like for Pulumi (for the sake of clarity program details which remain unchanged were left off this new diagram version):<br><br><img src=pulumi-actual.png alt="Pulumi Actual Architecture" style="display:block;margin:0 auto;length:600px;width:500px"></p><p>Clearing up these confusion points results in a better understanding when talking about project boundaries. When examining these boundaries, you might make the assumption that these boxes are isolated contexts and thus each project deploys independently from each other. While possibly true, this isn&rsquo;t a hard and fast requirement. Imagine a situation where you have static assets that don&rsquo;t change often. Perhaps you have an S3 bucket that stores image files for a website. The bucket might get used in multiple places (multiple websites) and thus lends itself to grouping under a shared infrastructure project. This grouping not only organizes resources by intent, but it can also help us prevent accidental destruction of these assets. If they were stored with more ephemeral resources, like servers that have a higher tendency of being torn down and spun up fresh, then there is inherently more risk that something could go wrong or would be destroyed unintentionally. In addition, splitting these projects up and sharing outputs from the stacks gives us incredible flexibility to segregate our resources by purpose, enabling us to adhere to single responsibility principals we know and love. The Pulumi documentation acknowledges that newcomers are likely to start with a monolithic stack (i.e.: everything in one project deploying via a single stack). While this works fine in some situations, the real power of these abstractions comes from the interplay across project boundaries and stacks. You can also reduce execution time by controlling which projects you run ​pulumi up​ on during a given deployment.</p><p>Let&rsquo;s walk through an example. This is a simple two project stack utilizing DigitalOcean Droplets (servers, think EC2) and DigitalOcean Spaces (object storage, think S3). In our first stack, we have a simple DigitalOcean Spaces bucket. In our second stack, we have a simple server hosting a blog application that allows users to post content. This content as you would likely suspect includes images that we want to store in our spaces bucket. DigitalOcean Spaces gives us a free CDN on top of their object storage solution, so it sounds like a good way to keep that load off our server and force the browser to pull that content from the bucket. I will be using C# to illustrate this example, however it is important to mention the APIs are very similar across languages:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>SharedStack</span> <span class=p>:</span> <span class=n>Stack</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>     [Output]</span><span class=err>​</span>
</span></span><span class=line><span class=cl>     <span class=kd>public</span> <span class=n>Output</span> <span class=n>BucketName</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>     [Output]</span>
</span></span><span class=line><span class=cl>     <span class=kd>public</span> <span class=n>Output</span> <span class=n>CdnEndpoint</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl>     <span class=kd>public</span> <span class=n>SharedStack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>bucket</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>DigitalOcean</span><span class=p>.</span><span class=n>SpacesBucket</span><span class=p>(</span><span class=s>&#34;my-bucket&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>               <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>DigitalOcean</span><span class=p>.</span><span class=n>SpacesBucketArgs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Region</span> <span class=p>=</span> <span class=s>&#34;nyc3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>Acl</span> <span class=p>=</span> <span class=s>&#34;private&#34;</span><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=err>​</span>               <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>cdn</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>DigitalOcean</span><span class=p>.</span><span class=n>Cdn</span><span class=p>(</span><span class=s>&#34;my-cdn&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>               <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>DigitalOcean</span><span class=p>.</span><span class=n>CdnArgs</span><span class=err>​</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Origin</span> <span class=p>=</span> <span class=n>bucket</span><span class=p>.</span><span class=n>BucketDomainName</span><span class=err>​</span>
</span></span><span class=line><span class=cl>               <span class=p>});</span><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=err>​</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Outputs​</span>
</span></span><span class=line><span class=cl>          <span class=n>BucketName</span> <span class=p>=</span> <span class=n>bucket</span><span class=p>.</span><span class=n>Name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>CdnEndpoint</span> <span class=p>=</span> <span class=n>cdn</span><span class=p>.</span><span class=n>Endpoint</span><span class=p>;</span><span class=err>​​</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>We can then import the outputs using a StackReference in our server stack!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>BlogStack</span> <span class=p>:</span> <span class=n>Stack</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=err>​</span>     <span class=kd>public</span> <span class=n>BlogStack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>sharedStack</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>StackReference</span><span class=p>(</span><span class=s>&#34;organization/project/environment&#34;</span><span class=p>);</span><span class=err>​</span>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>bucketName</span> <span class=p>=</span> <span class=n>sharedStack</span><span class=p>.</span><span class=n>RequireOutput</span><span class=p>(</span><span class=s>&#34;BucketName&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>cdnEndpoint</span> <span class=p>=</span> <span class=n>sharedStack</span><span class=p>.</span><span class=n>RequireOutput</span><span class=p>(</span><span class=s>&#34;CdnEndpoint&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>userData</span> <span class=p>=</span> <span class=n>Output</span><span class=p>.</span><span class=n>All</span><span class=p>(</span><span class=n>bucketName</span><span class=p>,</span> <span class=n>cdnEndpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=n>Apply</span><span class=p>(</span><span class=n>t</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>              <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=kt>var</span> <span class=n>userData</span> <span class=p>=</span> <span class=s>&#34;#!/bin/bash&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                  <span class=c1>// Set environment variables</span>
</span></span><span class=line><span class=cl>                  <span class=n>userData</span> <span class=p>+=</span> <span class=s>$&#34;\necho \&#34;</span><span class=n>Bucket</span><span class=p>=</span><span class=err>\\\</span><span class=s>&#34;{t[0]}\\\&#34;\&#34; | sudo tee -a /etc/environment&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                  <span class=n>userData</span> <span class=p>+=</span> <span class=s>$&#34;\necho \&#34;</span><span class=n>CDN</span><span class=p>=</span><span class=err>\\\</span><span class=s>&#34;https://{t[1]}/\\\&#34;\&#34; | sudo tee -a /etc/environment&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                  <span class=k>return</span> <span class=n>Output</span><span class=p>.</span><span class=n>CreateSecret</span><span class=p>(</span><span class=n>userData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kt>var</span> <span class=n>webServer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>DigitalOcean</span><span class=p>.</span><span class=n>Droplet</span><span class=p>(</span><span class=s>&#34;my-server&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>               <span class=k>new</span> <span class=n>Pulumi</span><span class=p>.</span><span class=n>DigitalOcean</span><span class=p>.</span><span class=n>DropletArgs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=n>Image</span> <span class=p>=</span> <span class=s>&#34;docker-20-04&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>Size</span> <span class=p>=</span> <span class=s>&#34;s-1vcpu-1gb&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>VpcUuid</span> <span class=p>=</span> <span class=n>vpcId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>PrivateNetworking</span> <span class=p>=</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>Region</span> <span class=p>=</span> <span class=s>&#34;nyc3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>SshKeys</span> <span class=p>=</span> <span class=p>{</span> <span class=n>sshKeyId</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                  <span class=n>UserData</span> <span class=p>=</span> <span class=n>userData</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span><span class=err>​</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=err>​</span>
</span></span></code></pre></td></tr></table></div></div><p>There is a ton of power here and we are only stratching the surface. The big takeaways are that you shouldn&rsquo;t be afraid of embracing multiple projects and stacks. Each stack is deployed via pulumi up independently, allowing you to focus on deploying only the infrastructure needed at a given time, reducing risk. It also enables a shared stack of resources you can use throughout your cloud solutions.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/infrastructure-as-code/>Infrastructure-as-Code</a>
<a href=/tags/digital-ocean/>Digital-Ocean</a>
<a href=/tags/cloud/>Cloud</a></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//shawn-vause.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
Copyright 2024 <a href=https://shawn.vause.us>Shawn Vause</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>