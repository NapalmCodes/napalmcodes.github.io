<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='An overview on setting up OpenTelemetry and OpenTelemetry Collector for .NET Core solutions, along with the necessary configuration to setup a cohesive observability solution utilizing OSS offerings Grafana, Grafana Tempo, Grafana Loki and Prometheus.'><meta name=author content='Shawn Vause'><meta name=copyright content='Shawn Vause'><title>OpenTelemetry for .NET Solutions with Grafana Tooling</title>
<link rel=canonical href=https://shawn.vause.us/posts/opentelemetry-dotnet/><link rel=stylesheet href=/scss/style.min.351dc9ac74547a9f9bbb90dff3482bcee8305593a3ad4ecba7c46081b5fba00d.css><meta property='og:title' content='OpenTelemetry for .NET Solutions with Grafana Tooling'><meta property='og:description' content='An overview on setting up OpenTelemetry and OpenTelemetry Collector for .NET Core solutions, along with the necessary configuration to setup a cohesive observability solution utilizing OSS offerings Grafana, Grafana Tempo, Grafana Loki and Prometheus.'><meta property='og:url' content='https://shawn.vause.us/posts/opentelemetry-dotnet/'><meta property='og:site_name' content="Shawn Vause - Shawn Vause's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='dotnet'><meta property='article:tag' content='opentelemetry'><meta property='article:tag' content='observability'><meta property='article:published_time' content='2024-02-24T00:00:00+00:00'><meta property='article:modified_time' content='2024-02-24T00:00:00+00:00'><meta name=twitter:site content="@SuperVause"><meta name=twitter:creator content="@SuperVause"><meta name=twitter:title content="OpenTelemetry for .NET Solutions with Grafana Tooling"><meta name=twitter:description content="An overview on setting up OpenTelemetry and OpenTelemetry Collector for .NET Core solutions, along with the necessary configuration to setup a cohesive observability solution utilizing OSS offerings Grafana, Grafana Tempo, Grafana Loki and Prometheus."><script async src="https://www.googletagmanager.com/gtag/js?id=G-KNPRK3WBWJ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KNPRK3WBWJ",{anonymize_ip:!1})}</script><script>document.onreadystatechange=function(){if(document.readyState=="complete"){var e=document.getElementById("recommendations-error");e&&e.remove()}}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/profile_hu2f761c4ecc1fe6bfe80b19bc1cf67e14_232950_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Shawn Vause's Blog</a></h1><h2 class=site-description>AWS Certified Full Stack Software Engineer</h2></div></header><ol class=social-menu><li><a href=https://www.credly.com/users/shawn-vause target=_blank title=Credly rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-certificate" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="15" cy="15" r="3"/><path d="M13 17.5V22l2-1.5 2 1.5v-4.5"/><path d="M10 19H5a2 2 0 01-2-2V7c0-1.1.9-2 2-2h14a2 2 0 012 2v10a2 2 0 01-1 1.73"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="12" x2="9" y2="12"/><line x1="6" y1="15" x2="8" y2="15"/></svg></a></li><li><a href=https://www.facebook.com/vause target=_blank title=Facebook rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-facebook" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li><li><a href=https://github.com/napalm684 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.instagram.com/napalm684 target=_blank title=Instagram rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-instagram" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="4"/><circle cx="12" cy="12" r="3"/><line x1="16.5" y1="7.5" x2="16.5" y2="7.501"/></svg></a></li><li><a href=https://www.linkedin.com/in/shawn-vause/ target=_blank title=Linkedin rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://twitter.com/SuperVause target=_blank title=X rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4l11.733 16H20L8.267 4z"/><path d="M4 20l6.768-6.768m2.46-2.46L20 4"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/opentelemetry-dotnet/>OpenTelemetry for .NET Solutions with Grafana Tooling</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 24, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><p>Observability of solutions has become a critical component of modern distributed applications that deserves more forethought and consideration than often afforded to it. Typically, implementing visibility to application functionality is relegated to a last minute implementation detail for the sole purpose of checking a box to indicate the system has been delivered with core expectations. While I can understand developers are strapped with a never-ending backlog of features to deliver (often features with percieved higher value to stakeholders) there is frankly no feature of higher value for development teams and those supporting their applications than observability. When you are awakened in the middle of the night from your slumber to solve a system problem, you want to see where the issue is quickly and with the &ldquo;right&rdquo; level of detail to indicate what the solution is likely to be. Not only is this beneficial to restoring functionality for your customers, but let&rsquo;s be honest, we need to get our asses back to bed quickly to handle the upcoming day. Enter <a href=https://opentelemetry.io title=OpenTelemetry>OpenTelemetry</a>, a tool to make our jobs easier and get the visibilty we need quickly, effectively and with a relatively easy implementation process.</p><p>OpenTelemetry (OTEL) is rapidly becoming the defacto solution for collecting observability data from our applications in the form of traces, metrics and logs (primer available <a href=https://opentelemetry.io/docs/concepts/observability-primer/ title="Observability Primer">here</a>). A key benefit of using OTEL, is that it is vendor agnostic and thus enables us to self-host our observability stack or choose from multiple vendors that support OTEL telemetry. By standardizing how we instrument our applications we can move faster and get intelligent insights that correlate events in complex distributed systems built with a variety of different technologies and programming languages. Luckily, OTEL&rsquo;s rise in popularity has lead to most modern languages providing an SDK to instrument across heterogenous distributed solutions. This post focuses on .NET based solutions, but be aware of the robust offerings available <a href=https://opentelemetry.io/docs/languages title="Language APIs & SDKs">here</a>. OTEL helps with the collection process of telemetry and getting it out of our way quickly and easily, so we can focus on instrumenting our apps and providing value for ourselves and support teams from the start of a development project.</p><h3 id=setup>Setup</h3><p>For this post, we are going to instrument a simple Web API solution using ASP.NET Core. Create a new ASP.NET core Web API project utilizing .NET 8 and install the following nuget packages (at time of writing this post):</p><div class=table-wrapper><table><tr><th>Package Name</th><th>Version</th><th>Description</th></tr><tr><td>OpenTelemetry</td><td>1.7.0</td><td>Core OTEL Functionality.</td></tr><td>OpenTelemetry.Exporter.Console</td><td>1.7.0</td><td>Basic data exporter displaying telemetry in stdout.</td></tr><td>OpenTelemetry.Exporter.OpenTelemetryProtocol</td><td>1.7.0</td><td>Data exporter using OTEL Protocol to transmit observability data (to OTEL Collector).</td></tr><td>OpenTelemetry.Extensions.Hosting</td><td>1.7.0</td><td>Extensions to utilize OTEL in the Microsoft Hosting environment.</td></tr><td>OpenTelemetry.Instrumentation.AspNetCore</td><td>1.7.1</td><td>Enables collection of ASP.NET Core observability data already built into it's libraries.</td></tr><td>OpenTelemetry.Instrumentation.Http</td><td>1.7.1</td><td>Enables collection of HTTPClient observability data (again already built into the libraries).</td></tr><td>OpenTelemetry.Instrumentation.Runtime</td><td>1.7.0</td><td>This is a cool one, get all the interesting observability data (allocations, garbage collections, etc.) from the dotnet runtime itself!</td></tr></table></div><h3 id=implementation>Implementation</h3><p>I am not sure if this is considered official best practice, but anytime I add a lot of &ldquo;noise&rdquo; to the dependency injection system, I always create a class(es) of extension methods to encapsulate core feature sets or group similar &ldquo;services&rdquo;. This helps keep the registration pipeline clean and readable. Create the following class as follows and we will step through it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>using</span> <span class=nn>OpenTelemetry.Instrumentation.AspNetCore</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>OpenTelemetry.Logs</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>OpenTelemetry.Metrics</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>OpenTelemetry.Resources</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>OpenTelemetry.Trace</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Diagnostics.Metrics</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>WebApplication1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>OpenTelemetryExtensions</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=n>Action</span><span class=p>&lt;</span><span class=n>ResourceBuilder</span><span class=p>&gt;</span> <span class=n>_ConfigureResource</span> <span class=p>=</span> 
</span></span><span class=line><span class=cl>		<span class=n>r</span> <span class=p>=&gt;</span> <span class=n>r</span><span class=p>.</span><span class=n>AddService</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>serviceName</span><span class=p>:</span> <span class=s>&#34;web-application-1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>serviceVersion</span><span class=p>:</span> <span class=k>typeof</span><span class=p>(</span><span class=n>Program</span><span class=p>).</span><span class=n>Assembly</span><span class=p>.</span><span class=n>GetName</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>Version</span><span class=p>?.</span><span class=n>ToString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=p>??</span> <span class=s>&#34;unknown&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>serviceInstanceId</span><span class=p>:</span> <span class=n>Environment</span><span class=p>.</span><span class=n>MachineName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=n>IServiceCollection</span> <span class=n>AddOpenTelemetryObservability</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span> <span class=n>IServiceCollection</span> <span class=n>services</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>IConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>services</span><span class=p>.</span><span class=n>AddOpenTelemetry</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>.</span><span class=n>ConfigureResource</span><span class=p>(</span><span class=n>_ConfigureResource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>.</span><span class=n>WithTracing</span><span class=p>(</span><span class=n>builder</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>AddSource</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>SetSampler</span><span class=p>(</span><span class=k>new</span> <span class=n>AlwaysOnSampler</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>AddHttpClientInstrumentation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>AddAspNetCoreInstrumentation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=n>services</span><span class=p>.</span><span class=n>Configure</span><span class=p>&lt;</span><span class=n>AspNetCoreTraceInstrumentationOptions</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>					<span class=n>configuration</span><span class=p>.</span><span class=n>GetSection</span><span class=p>(</span><span class=s>&#34;AspNetCoreInstrumentation&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>SetupTracingExporter</span><span class=p>(</span><span class=n>configuration</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=p>.</span><span class=n>WithMetrics</span><span class=p>(</span><span class=n>builder</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Used to record/export specific types </span>
</span></span><span class=line><span class=cl>					<span class=c1>// of metrics (counters, gagues, etc.)</span>
</span></span><span class=line><span class=cl>					<span class=c1>//.AddMeter()</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>AddRuntimeInstrumentation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>AddHttpClientInstrumentation</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>AddAspNetCoreInstrumentation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>SetupMetricsView</span><span class=p>(</span><span class=n>configuration</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>SetupMetricsExporter</span><span class=p>(</span><span class=n>configuration</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>services</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>AddOpenTelemetryLogging</span><span class=p>(</span><span class=k>this</span> <span class=n>ILoggingBuilder</span> <span class=n>builder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>IConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>var</span> <span class=n>logExporter</span> <span class=p>=</span> <span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;UseLogExporter&#34;</span><span class=p>,</span> <span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34;console&#34;</span><span class=p>)!.</span><span class=n>ToLowerInvariant</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>builder</span><span class=p>.</span><span class=n>ClearProviders</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>builder</span><span class=p>.</span><span class=n>AddOpenTelemetry</span><span class=p>(</span><span class=n>options</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>var</span> <span class=n>resourceBuilder</span> <span class=p>=</span> <span class=n>ResourceBuilder</span><span class=p>.</span><span class=n>CreateDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=n>_ConfigureResource</span><span class=p>(</span><span class=n>resourceBuilder</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>options</span><span class=p>.</span><span class=n>SetResourceBuilder</span><span class=p>(</span><span class=n>resourceBuilder</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>options</span><span class=p>.</span><span class=n>SetupLogsExporter</span><span class=p>(</span><span class=n>logExporter</span><span class=p>,</span> <span class=n>configuration</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>SetupTracingExporter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span> <span class=n>TracerProviderBuilder</span> <span class=n>builder</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>		<span class=n>IConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>var</span> <span class=n>tracingExporter</span> <span class=p>=</span> <span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;UseTracingExporter&#34;</span><span class=p>,</span> <span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34;console&#34;</span><span class=p>)!.</span><span class=n>ToLowerInvariant</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=p>(</span><span class=n>tracingExporter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;otlp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>AddOtlpExporter</span><span class=p>(</span><span class=n>otlpOptions</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>otlpOptions</span><span class=p>.</span><span class=n>Endpoint</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;Otlp:Endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34; http://localhost:4317&#34;</span><span class=p>)!);</span>
</span></span><span class=line><span class=cl>				<span class=p>});</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>AddConsoleExporter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>SetupMetricsExporter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span> <span class=n>MeterProviderBuilder</span> <span class=n>builder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>IConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>var</span> <span class=n>metricsExporter</span> <span class=p>=</span> 
</span></span><span class=line><span class=cl>			<span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span><span class=s>&#34;UseMetricsExporter&#34;</span><span class=p>,</span> <span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34;console&#34;</span><span class=p>)!</span>
</span></span><span class=line><span class=cl>				<span class=p>.</span><span class=n>ToLowerInvariant</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=p>(</span><span class=n>metricsExporter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;otlp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>AddOtlpExporter</span><span class=p>(</span><span class=n>otlpOptions</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>otlpOptions</span><span class=p>.</span><span class=n>Endpoint</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;Otlp:Endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34; http://localhost:4317&#34;</span><span class=p>)!);</span>
</span></span><span class=line><span class=cl>				<span class=p>});</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>AddConsoleExporter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>SetupMetricsView</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span> <span class=n>MeterProviderBuilder</span> <span class=n>builder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>IConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>var</span> <span class=n>histogramAggregation</span> <span class=p>=</span> 
</span></span><span class=line><span class=cl>			<span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;HistogramAggregation&#34;</span><span class=p>,</span> <span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34;explicit&#34;</span><span class=p>)!</span>
</span></span><span class=line><span class=cl>					<span class=p>.</span><span class=n>ToLowerInvariant</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=p>(</span><span class=n>histogramAggregation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;exponential&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>builder</span><span class=p>.</span><span class=n>AddView</span><span class=p>(</span><span class=n>instrument</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=n>instrument</span><span class=p>.</span><span class=n>GetType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=p>.</span><span class=n>GetGenericTypeDefinition</span><span class=p>()</span> <span class=p>==</span> 
</span></span><span class=line><span class=cl>						<span class=k>typeof</span><span class=p>(</span><span class=n>Histogram</span><span class=p>&lt;&gt;)</span>
</span></span><span class=line><span class=cl>					<span class=p>?</span> <span class=k>new</span> <span class=n>Base2ExponentialBucketHistogramConfiguration</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>});</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Explicit bounds histogram is default, nothing to do.</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>SetupLogsExporter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span> <span class=n>OpenTelemetryLoggerOptions</span> <span class=n>options</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>		<span class=kt>string</span> <span class=n>logExporter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>IConfiguration</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=p>(</span><span class=n>logExporter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;otlp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>options</span><span class=p>.</span><span class=n>AddOtlpExporter</span><span class=p>(</span><span class=n>otlpOptions</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>otlpOptions</span><span class=p>.</span><span class=n>Endpoint</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=n>configuration</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s>&#34;Otlp:Endpoint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=n>defaultValue</span><span class=p>:</span> <span class=s>&#34; http://localhost:4317&#34;</span><span class=p>)!);</span>
</span></span><span class=line><span class=cl>				<span class=p>});</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=n>options</span><span class=p>.</span><span class=n>AddConsoleExporter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=configuration>Configuration</h4><p>The code is pretty readable in my opinion, but essentially we are using a configuration file with the following structure to drive the appropriate OTEL behaviors:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Logging&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;LogLevel&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Default&#34;</span><span class=p>:</span> <span class=s2>&#34;Information&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;Microsoft.AspNetCore&#34;</span><span class=p>:</span> <span class=s2>&#34;Warning&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;UseTracingExporter&#34;</span><span class=p>:</span> <span class=s2>&#34;otlp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;UseMetricsExporter&#34;</span><span class=p>:</span> <span class=s2>&#34;otlp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;UseLogExporter&#34;</span><span class=p>:</span> <span class=s2>&#34;otlp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;HistogramAggregation&#34;</span><span class=p>:</span> <span class=s2>&#34;explicit&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;AspNetCoreInstrumentation&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RecordException&#34;</span><span class=p>:</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;Otlp&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Endpoint&#34;</span><span class=p>:</span> <span class=s2>&#34;http://localhost:4317&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;AllowedHosts&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>For each &ldquo;<em>Use&lt;Data Type>Exporter</em>&rdquo; property we take two string values currently &ldquo;console&rdquo; or &ldquo;otlp&rdquo;. This configures the system to use either a console exporter (great for testing) or the OpenTelemetry Protocol which is a vendor/tool agnostic protocol for transmitting traces, metrics and logs telemetry to another service. We will use something called the OTEL Collector as this service, but be aware that logging tools like DataDog and others support OTLP protocol natively in some cases. In addition, we provide an OTLP endpoint for sending data to the OTEL collector from our API. The last parameter controls how the histogram buckets metric data (explicit boundaries vs exponential scales).</p><h4 id=code-explanation>Code Explanation</h4><p>There are two public extension methods in the class defined above. One controls setting up the traces and metrics collection process for OTEL and the other (while similar) sets up the application logging provider. Using the settings from the <code>appsettings.json</code> file we add appropriate exporters for getting observability data points out of our API. You will also notice that we add instrumentation for the various .NET core functionality that is made available to us (HTTPClient, Dotnet Runtime, AspNetCore) for trace and metrics. This is incredibly powerful by itself as a ton of telemetry for our solution is already built-in just waiting for us to export it somewhere we can make use of it!</p><p>Another important callout, is the use of the <code>ConfigureResource</code> action method. OTEL will use the value configured as a service name tag value. This is really useful for grouping telemetry in an environment where maybe there are many distributed services working independently/interactively. It also allows us to tag our telemetry with a software version (think about handling blue/green deployments and rolling updates where multiple version of a service are live at the same time) and a machine name where the data originated from (load balanced environments).</p><h4 id=hook-up>Hook Up</h4><p>To utilize the extension methods above it is easy to wire them into the HTTP builder pipeline for your web application. In <code>Program.cs</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>var</span> <span class=n>builder</span> <span class=p>=</span> <span class=n>WebApplication</span><span class=p>.</span><span class=n>CreateBuilder</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add this line below the above builder assignment to add OpenTelemetry for tracing and metrics.</span>
</span></span><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Services</span><span class=p>.</span><span class=n>AddOpenTelemetryObservability</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=n>Configuration</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add this line to add OpenTelemetry for logging.</span>
</span></span><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Logging</span><span class=p>.</span><span class=n>AddOpenTelemetryLogging</span><span class=p>(</span><span class=n>builder</span><span class=p>.</span><span class=n>Configuration</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>I would recommend starting with the <em>console</em> exporter and verifying that you start to see OTEL yaml for logs and metrics/trace data being written out to the console window.</p><p>In my next post, I will discuss taking this data from the console and pushing it to the OpenTelemetry Collector for display in Grafana! We will also touch on adding custom instrumentation to your code!</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dotnet/>Dotnet</a>
<a href=/tags/opentelemetry/>Opentelemetry</a>
<a href=/tags/observability/>Observability</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/maui-free-ios-provisioning/><div class=article-details><h2 class=article-title>.NET MAUI iOS Free Provisioning</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//shawn-vause.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
Copyright 2024 <a href=https://shawn.vause.us>Shawn Vause</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>